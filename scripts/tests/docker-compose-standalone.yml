# Docker compose file to deploy using docker-compose, or docker swarm
version: '3.5'
services:
  gisaia-spark-master:
    image: gisaia/spark:2.3.1
    build:
      context: .
      dockerfile: ./spark/Dockerfile
    # WE CAN ADD FOLLOWING PARAMETERS TO THE WORKER:  -i localhost -p 8881 -c 2 -m 512m -d /conf --webui-port 8081
    command: >
     bash -c "spark-class org.apache.spark.deploy.master.Master -h gisaia-spark-master &
     spark-class org.apache.spark.deploy.worker.Worker spark://gisaia-spark-master:7077 -c 2 -m 512m"
    hostname: gisaia-spark-master
    container_name: gisaia-spark-master
    environment:
      MASTER: spark://gisaia-spark-master:7077
      SPARK_CONF_DIR: /conf
      SPARK_PUBLIC_DNS: localhost
    expose:
      - 7001
      - 7002
      - 7003
      - 7004
      - 7005
      - 7006
      - 7077
      - 6066
    ports:
      - 8080:8080
      - 7077:7077
      # We need the following port 8081 to access the webui of the worker, if we change the port in worker command we have to change here as well.
      - 8081:8081
    volumes:
      - ../..:/opt/work
    restart: always
    networks:
      - gisaia-network
  gisaia-scylla-db:
      image: scylladb/scylla:2.2.0
      hostname: gisaia-scylla-db
      container_name: gisaia-scylla-db
      environment:
        - DC1=DC1
        - CLUSTER_NAME=gisaia C*
        - RPC_ADDRESS=gisaia-scylla-db
        - CQLSH_HOST=gisaia-scylla-db
      ports:
        - 9042:9042
        - 7000:7000
        - 7001:7001
        - 7199:7199
        - 9160:9160
        - 10000:10000
      restart: always
      volumes:
        - /tmp/data/scylla-db:/var/lib/scylla-db
      networks:
        - gisaia-network
  gisaia-elasticsearch:
    image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION:-6.4.0}
    hostname: gisaia-elasticsearch
    container_name: gisaia-elasticsearch
    environment:
    - cluster.name=docker-cluster
    - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
    - xpack.security.enabled=false
    - xpack.monitoring.enabled=false
    - xpack.graph.enabled=false
    - xpack.watcher.enabled=false
    ports:
    - 9200:9200
    - 9300:9300
    networks:
    - gisaia-network
networks:
  gisaia-network:
    name: gisaia-network
    external: false
