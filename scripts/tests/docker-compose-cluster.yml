version: '3.5'
services:
  gisaia-spark-master:
    image: gisaia/spark:latest
    build:
      context: .
      dockerfile: ./spark/Dockerfile
    command: spark-class org.apache.spark.deploy.master.Master -h gisaia-spark-master
    hostname: gisaia-spark-master
    container_name: gisaia-spark-master
    environment:
      MASTER: spark://gisaia-spark-master:7077
      SPARK_CONF_DIR: /conf
      SPARK_PUBLIC_DNS: localhost
    expose:
      - 7001
      - 7002
      - 7003
      - 7004
      - 7005
      - 7006
      - 7077
      - 6066
    ports:
      - 8080:8080
      - 7077:7077
    volumes:
      - ../..:/opt/work
    restart: always
    networks:
      - gisaia-network
  gisaia-spark-worker-1:
      image: gisaia/spark:latest
      build:
        context: .
        dockerfile: ./spark/Dockerfile
      command: spark-class org.apache.spark.deploy.worker.Worker spark://gisaia-spark-master:7077 -c 2 -m 512m
      hostname: gisaia-spark-worker-1
      container_name: gisaia-spark-worker-1
      environment:
        SPARK_CONF_DIR: /conf
        SPARK_WORKER_CORES: 2
        SPARK_WORKER_MEMORY: 512m
        SPARK_WORKER_PORT: 8881
        SPARK_WORKER_WEBUI_PORT: 8081
        SPARK_PUBLIC_DNS: localhost
      expose:
        - 7012
        - 7013
        - 7014
        - 7015
        - 7016
        - 8881
      ports:
        - 8081:8081
      volumes:
        - ../..:/opt/work
      restart: always
      networks:
        - gisaia-network
  gisaia-spark-worker-2:
      image: gisaia/spark:latest
      build:
        context: .
        dockerfile: ./spark/Dockerfile
      command: spark-class org.apache.spark.deploy.worker.Worker spark://gisaia-spark-master:7077 -c 2 -m 512m
      hostname: gisaia-spark-worker-2
      container_name: gisaia-spark-worker-2
      environment:
        SPARK_CONF_DIR: /conf
        SPARK_WORKER_CORES: 2
        SPARK_WORKER_MEMORY: 512m
        SPARK_WORKER_PORT: 8882
        SPARK_WORKER_WEBUI_PORT: 8082
        SPARK_PUBLIC_DNS: localhost
      expose:
        - 7017
        - 7018
        - 7019
        - 7020
        - 7021
        - 8882
      ports:
        - 8082:8082
      volumes:
        - ../..:/opt/work
      restart: always
      networks:
        - gisaia-network
  gisaia-scylla-db:
      image: scylladb/scylla:2.2.0
      hostname: gisaia-scylla-db
      container_name: gisaia-scylla-db
      command: "--seeds gisaia-scylla-db,gisaia-scylla-db-n2 --smp 1 --memory 256M"
      environment:
      - DC1=DC1
      - CLUSTER_NAME=gisaia C*
      - RPC_ADDRESS=gisaia-scylla-db
      - CQLSH_HOST=gisaia-scylla-db
      ports:
      - 9042:9042
      - 7000:7000
      - 7001:7001
      - 7199:7199
      - 9160:9160
      - 10000:10000
      restart: always
      volumes:
        - /tmp/data/scylla-db-n1:/var/lib/scylla-db
      networks:
        - gisaia-network
  gisaia-scylla-db-n2:
      image: scylladb/scylla:2.2.0
      hostname: gisaia-scylla-db-n2
      container_name: gisaia-scylla-db-n2
      command: "--seeds gisaia-scylla-db,gisaia-scylla-db-n2 --smp 1 --memory 256M"
      restart: always
      volumes:
        - /tmp/data/scylla-db-n2:/var/lib/scylla-db
      networks:
        - gisaia-network
  elasticsearch:
      image: docker.elastic.co/elasticsearch/elasticsearch:${ELASTIC_VERSION:-6.4.0}
      hostname: gisaia-elasticsearch
      container_name: gisaia-elasticsearch
      environment:
      - cluster.name=docker-cluster
      - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      - xpack.security.enabled=false
      - xpack.monitoring.enabled=false
      - xpack.graph.enabled=false
      - xpack.watcher.enabled=false
      ports:
      - 19200:9200
      - 19300:9300
      networks:
      - gisaia-network
networks:
  gisaia-network:
    name: gisaia-network
    external: false
